---
title: "RR_Trial"
author: "Rakendu"
date: '2022-06-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      warning = FALSE,
                      message = FALSE)
```



```{r}
packages = c('tidyverse','ggdist','gghalves','ggthemes','hrbrthemes','ggridges','patchwork','zoo', 'ggrepel','ggiraph','lubridate','gganimate','scales','viridis','tsibble','forecast','fpp3','tseries')
for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}

```

```{r}
financial_data <- read_csv("data/FinancialJournal.csv")
participants_data <- read_csv("data/Participants.csv")
```


```{r}

forecast_data <- dataset_1 %>%
  filter(educationLevel == "Low") %>%
  filter(agegroup == "50-60") %>%
  mutate(Time = yearmonth(timestamp))%>%
  group_by(Time,participantId) %>%
  summarise(income = sum(ifelse(amount > 0,amount,0)), expense = sum(ifelse(amount <= 0,amount,0))) %>%
  ungroup() %>%
  group_by(Time) %>%
  summarise(income = mean(income),expense = mean(expense))

forecast_data <- as_tsibble(forecast_data, index = Time)

```
```{r}

        forecast_data %>%
          model(ARIMA(income,order=c(1,0,0))) %>%
          forecast(h = "12 months") %>%
          autoplot(forecast_data) +
  theme_light()
```



```{r}
  participants_data$agegroup <- cut(participants_data$age, breaks = c(17,30,40,50,60), 
                             labels = c("18-30","30-40","40-50","50-60"))

level_order <- c('Graduate','Bachelors','HighSchoolOrCollege','Low')

dataset_1 <- financial_data %>%
    inner_join(select(participants_data,participantId, educationLevel,agegroup), by =c('participantId'))%>%
    mutate(educationLevel = factor(educationLevel, levels = level_order)) %>%
  mutate(YearMon = as.yearmon(timestamp))
```

```{r fig.width=16, fig.height=8}

Part_0_fin <- financial_data %>%
  filter(participantId == 0) %>%
  mutate(YearMon = as.yearmon(timestamp))%>%
  group_by(YearMon, category) %>%
  summarise(amount = sum(amount)) %>%
  mutate( amount = ifelse(amount < 0,-amount,amount))

```

```{r  fig.width=16, fig.height=10}


dataset_1%>%
        filter(educationLevel == "Graduate")%>%
  filter(agegroup =="18-30") %>%
  group_by(YearMon, category) %>%
  summarise(amount = sum(amount)) %>%
  mutate( amount = ifelse(amount < 0,-amount,amount))%>%
  mutate( percentage = amount/sum(amount)) %>%
  ggplot(aes(x=YearMon, 
             y = percentage, 
             fill =factor(category,levels=c("Wage","Shelter","Recreation","Food","Education","RentAdjustment")))) +
  geom_area(alpha=0.6, size=1,colour="white") +
      scale_fill_viridis(discrete = T) +
    ggtitle("Income and Expense") +
    theme(axis.title.y=element_text(angle =0),
        axis.title.x=element_text(margin = margin(t=-10)),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        panel.grid.major.y = element_line(colour = "grey90"),
        panel.background = element_rect(fill = "white"),
        axis.text.x = element_text(size =16, angle = 45, margin = margin(t = 30)),
        axis.text.y = element_text(size =16),
        axis.line = element_line(color="grey25", size = 0.02),
        axis.title = element_text(size=16),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        plot.title = element_text(size =20,hjust = 0.5)) +
  scale_fill_discrete(name = "Category")
```




```{r fig.width=16, fig.height=8}

Part_0_fin <- financial_data %>%
  mutate(YearMon = as.yearmon(timestamp))%>%
  group_by(YearMon, category) %>%
  summarise(amount = mean(amount)) %>%
  mutate( amount = ifelse(amount < 0,-amount,amount))%>%
  mutate( percentage = amount/sum(amount))

Part_0_fin%>%
  ggplot(aes(x=YearMon, 
             y = percentage, 
             fill = factor(category,levels=c("Wage","Shelter","Recreation","Food","Education","RentAdjustment")))) +
  geom_area(alpha=0.6, size=1,colour="white") +
  facet_grid(category ~.)+
      scale_fill_viridis(discrete = T) +
    ggtitle("Income and Expense") +
    theme(axis.title.y=element_text(angle =0),
        axis.title.x=element_text(margin = margin(t=-10)),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        panel.grid.major.y = element_line(colour = "grey90"),
        panel.background = element_rect(fill = "white"),
        axis.text.x = element_text(size =16, angle = 45, margin = margin(t = 30)),
        axis.text.y = element_text(size =16),
        axis.line = element_line(color="grey25", size = 0.02),
        axis.title = element_text(size=16),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 16),
        plot.title = element_text(size =20,hjust = 0.5)) +
  scale_fill_discrete(name = "Category")
```



## Income grouped by education level




```{r}

write_rds(participant_fin,"data/rds/participant_fin.rds")
```

```{r}

participant_fin <- read_rds("data/rds/participant_fin.rds")

```





```{r  fig.width=16, fig.height=8}

Education_fin %>%
  ggplot(aes(x=date, y = income,fill =educationLevel))+
  geom_area(size = 0.75)+
  ylab("Income")+
  xlab("Month, Year")+
  theme(axis.title.y=element_text(angle =0),
        axis.title.x=element_text(margin = margin(t=-10)),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        panel.grid.major.y = element_line(colour = "grey90"),
        panel.background = element_rect(fill = "white"),
        axis.text.x = element_text(size =16, angle = 45, margin = margin(t = 30)),
        axis.text.y = element_text(size =16),
        axis.line = element_line(color="grey25", size = 0.02),
        axis.title = element_text(size=16),
        legend.title = element_text(size =16),
        legend.text = element_text(size = 16),
        plot.title = element_text(size =20,hjust = 0.5))+
  ggtitle("Average Income by Education Level")+
  scale_fill_brewer(palette = "Set2")+
  scale_y_continuous(breaks = seq(0,30000,5000))

```

## Income grouped by Age Group


```{r}

age_fin <- participant_fin %>%
  group_by(educationLevel,date) %>%
  summarise(income = mean(income), expense= mean(expense))
  
```


```{r  fig.width=16, fig.height=8}

age_fin %>%
  ggplot(aes(x=date, y = income,fill =educationLevel))+
  geom_area(size = 0.75)+
  ylab("Income")+
  xlab("Month, Year")+
  theme(axis.title.y=element_text(angle =0),
        axis.title.x=element_text(margin = margin(t=-10)),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        panel.grid.major.y = element_line(colour = "grey90"),
        panel.background = element_rect(fill = "white"),
        axis.text.x = element_text(size =16, angle = 45, margin = margin(t = 30)),
        axis.text.y = element_text(size =16),
        axis.line = element_line(color="grey25", size = 0.02),
        axis.title = element_text(size=16),
        legend.title = element_text(size =16),
        legend.text = element_text(size = 16),
        plot.title = element_text(size =20,hjust = 0.5))+
  ggtitle("Average Income by Age Group")+
  scale_fill_brewer(palette = "Set2")+
  scale_y_continuous(breaks = seq(0,30000,5000))

```

### Graph 2 - Income and expense of different Education Groups/Age Groups
# Add Legend separately?

```{r}
  participants_data$agegroup <- cut(participants_data$age, breaks = c(17,30,40,50,60), 
                             labels = c("18-30","30-40","40-50","50-60"))

level_order <- c('Graduate','Bachelors','HighSchoolOrCollege','Low')

dataset_1 <- financial_data %>%
    inner_join(select(participants_data,participantId, educationLevel,agegroup), by =c('participantId'))%>%
    mutate(educationLevel = factor(educationLevel, levels = level_order)) %>%
  mutate(YearMon = as.yearmon(timestamp))
```

```{r}

dataset_2 <- dataset_1 %>%
  group_by(participantId, YearMon, educationLevel,agegroup) %>%
  summarise(income = sum(ifelse(amount > 0,amount,0)), expense = sum(ifelse(amount <= 0,amount,0))) %>%
  mutate(savings = round(income + expense,digits = 0))%>%
  ungroup()%>%
  group_by(YearMon, educationLevel,agegroup) %>%
  summarise(income = mean(income),expense = mean(expense))


```

```{r}

dataset_3 <- dataset_1 %>%
  mutate(Label = ifelse(YearMon == max(YearMon), ifelse(amount >= 0,"Income","Expense"), NA)) %>%
  mutate(revenue = ifelse(amount >= 0,"Income","Expense")) %>%
  group_by(participantId, YearMon, educationLevel,agegroup, Label,revenue) %>%
  summarise(amount = sum(amount)) %>%
  ungroup()%>%
  group_by(YearMon, educationLevel,agegroup, Label,revenue) %>%
  summarise(amount = mean(amount))


```

```{r  fig.width=16, fig.height=8}

dataset_3 %>%
  filter(educationLevel == "Graduate") %>%
  filter(agegroup == "18-30") %>%
  ggplot(aes(x=YearMon, y = amount, group = revenue))+
  geom_line(aes(color = revenue), size = 1)+
  geom_label(aes(label = Label), size = 4) +
  ylab("Income")+
  xlab("Month, Year")+
  theme(axis.title.y=element_text(angle =0),
        axis.title.x=element_text(margin = margin(t=-10)),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        panel.grid.major.y = element_line(colour = "grey90"),
        panel.background = element_rect(fill = "white"),
        axis.text.x = element_text(size =16, angle = 45, margin = margin(t = 30)),
        axis.text.y = element_text(size =16),
        axis.line = element_line(color="grey25", size = 0.02),
        axis.title = element_text(size=16),
        legend.position = "none",
        plot.title = element_text(size =20,hjust = 0.5))+
  ggtitle("Average Income by Education Level")

```


```{r  fig.width=16, fig.height=8}

dataset_3 %>%
  ggplot(aes(x=YearMon, y = amount, group = revenue))+
  geom_line(aes(color = revenue), size = 1)+
  geom_text(aes(label = Label),nudge_x = 0.15, size = 4) +
  facet_grid(educationLevel ~ agegroup)+
  ylab("Income")+
  xlab("Month, Year")+
  theme(axis.title.y=element_text(angle =0),
        axis.title.x=element_text(margin = margin(t=-10)),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        panel.grid.major.y = element_line(colour = "grey90"),
        panel.background = element_rect(fill = "white"),
        axis.text.x = element_text(size =16, angle = 45, margin = margin(t = 30)),
        axis.text.y = element_text(size =16),
        axis.line = element_line(color="grey25", size = 0.02),
        axis.title = element_text(size=16),
        legend.position = "none",
        plot.title = element_text(size =20,hjust = 0.5))+
  ggtitle("Average Income by Education Level")

```

```{r}

Education_fin <- participant_fin %>%
  group_by(educationLevel,date) %>%
  summarise(income = mean(income), expense= mean(expense))
  
```

```{r  fig.width=16, fig.height=8}

dataset_2 %>%
  filter(educationLevel == "Graduate") %>%
  filter(agegroup == "18-30") %>%
  ggplot(aes(x=YearMon))+
  geom_line(aes(y=income),color ="steelblue", label = "income")+
      geom_label() +
  geom_line(aes(y=-expense), color = "darkred")+
  ylab("Income")+
  xlab("Month, Year")+
  theme(axis.title.y=element_text(angle =0),
        axis.title.x=element_text(margin = margin(t=-10)),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_line(colour = "grey90"),
        panel.grid.major.x = element_line(colour = "grey90"),
        panel.grid.major.y = element_line(colour = "grey90"),
        panel.background = element_rect(fill = "white"),
        axis.text.x = element_text(size =16, angle = 45, margin = margin(t = 30)),
        axis.text.y = element_text(size =16),
        axis.line = element_line(color="grey25", size = 0.02),
        axis.title = element_text(size=16),
        legend.title = element_text(size =16),
        legend.text = element_text(size = 16),
        plot.title = element_text(size =20,hjust = 0.5))+
  ggtitle("Average Income by Education Level")

```
### Average income and expense grouped by different periods 


```{r}


  participant_period_fin <- financial_data %>%
      group_by(participantId,timestamp) %>%
    summarise(income = sum(ifelse(amount > 0,amount,0)), expense = sum(ifelse(amount <= 0,amount,0)))%>%
  mutate(MonthYear = as.yearmon(timestamp)) %>%
    mutate(week_day = weekdays(timestamp)) %>%
    mutate(day_of_month = day(timestamp)) %>%
    mutate(hour_of_day = hour(timestamp))
  
```



```{r}
level_order <- c('Graduate','Bachelors','HighSchoolOrCollege','Low')

Fin_data_for_plot <- participant_period_fin%>%
    inner_join(participants_data[,c("participantId","educationLevel","age")], by =c('participantId'))%>%
  mutate(educationLevel = factor(educationLevel, levels = level_order)) %>%
  mutate(agegroup =  cut(age, breaks = c(17,30,40,50,60), 
                             labels = c("18-30","30-40","40-50","50-60")))


```


```{r}

write_rds(Fin_data_for_plot,"data/rds/Fin_data_for_plot.rds")
```
```{r}

Fin_data_for_plot <- read_rds("data/rds/Fin_data_for_plot.rds")
```

```{r}


Fin_data_for_plot%>%
  group_by(educationLevel, week_day)%>%
  summarise(avgincome = mean(income), avgexpense= mean(expense))  %>%
  ggplot(aes(x=week_day, y = avgincome, group = educationLevel))+
  geom_line(aes(color = educationLevel))+
  geom_point()

```


```{r}


Fin_data_for_plot%>%
  group_by(week_day, educationLevel)%>%
  summarise(avgincome = mean(income), avgexpense= mean(expense))  %>%
  ggplot(aes(x=week_day, y = -avgexpense, group = educationLevel))+
  geom_line(aes(color = educationLevel))+
  geom_point()

```
## Filter above plot for each education level - Not working

```{r}


Fin_data_for_plot%>%
  filter(educationLevel== "Graduate") %>%
  group_by(week_day)%>%
  summarise(avgincome = mean(income), avgexpense= mean(expense))%>%
  ggplot(aes(x=week_day, y = avgincome))+
  geom_point()+
  geom_line(color = "steelblue")
```


```{r}


Fin_data_for_plot%>%
  filter(educationLevel== "Graduate") %>%
    group_by(week_day)%>%
  summarise(avgincome = mean(income), avgexpense= mean(expense)) %>%
  ggplot(aes(x=week_day, y = avgincome))+
  geom_line(color= "red")
  geom_point()

```

###Heatmap - expenses of participants dynamically group by period

```{r fig.width=16, fig.height=8}
wkday_levels <- c( 'Friday', 
                  'Thursday', 'Wednesday', 
                  'Tuesday', 'Monday', 
                  'Sunday','Saturday')

expense_data <- financial_data %>%
  mutate(date = as.Date(timestamp,"%m/%d/%Y")) %>%
  mutate(expense = round(abs(ifelse(amount<=0,amount,0)))) %>%
  filter(expense>0) %>%
  group_by(date)%>%
  summarise(AvgExpense = mean(expense))%>%
  mutate(wkday = factor(weekdays(date),levels = wkday_levels)) %>%
  mutate(wknumber = week(date))

expense_data%>%
  ggplot(aes(wknumber,wkday,fill=AvgExpense))+
  geom_tile(color = "white", size = 0.1)+
  theme_tufte(base_family = "Helvetica")+
  coord_equal() +
  scale_fill_gradient(name = "Expense",
                    low = "sky blue", 
                    high = "dark blue",
                    labels = comma)+
  labs(x = "Weeks of the Year",
       y = NULL,
       title = "Average Weekly Expense of Residents") +
  theme(axis.text = element_text(size = 16,margin = margin(r = -60)),
        axis.ticks.y= element_blank(),
        legend.title = element_text(size =16),
        legend.text = element_text(size = 16),
        axis.title.x = element_text(size=14))

```

```{r fig.width=16, fig.height=8}
wkday_levels <- c( 'Friday', 
                  'Thursday', 'Wednesday', 
                  'Tuesday', 'Monday', 
                  'Sunday','Saturday')
wk_levels <- c(5,4,3,2,1)

dataset_4 <- dataset_1 %>%
  filter(!category %in% c("Shelter")) %>%
  filter(amount<0) %>%
  mutate(date = as.Date(timestamp,"%m/%d/%Y")) %>%
    filter(date <'2023-03-01')%>%
  mutate(wkday = factor(weekdays(date),levels = wkday_levels)) %>%
  mutate(month = month(date)) %>%
  mutate(day = day(date)) %>%
  mutate(wkofmonth = factor(week(date) - week(floor_date(date, unit = "months")),levels = wk_levels)) %>%
  group_by(participantId, date, category, educationLevel, agegroup,wkday,month,wkofmonth,day) %>%
  summarise(amount = sum(amount)) %>%
  ungroup() %>%
  group_by(date,educationLevel,agegroup,wkday,month,wkofmonth,day)%>%
  summarise(Avgexpense = mean(amount))

```


```{r}
wkday_levels <- c('Sun','Mon','Tue','Wed','Thu','Fri','Sat')
wk_levels <- c(6,5,4,3,2,1,0)

dataset_4 <- dataset_1 %>%
  filter(!category %in% c("Shelter","Education")) %>%
  filter(amount<0) %>%
  mutate(date = as.Date(timestamp,"%m/%d/%Y")) %>%
    filter(date <'2023-03-01')%>%
  mutate(wkday = factor(weekdays(date,abbreviate = TRUE),levels = wkday_levels)) %>%
  mutate(month = month(date,label = TRUE)) %>%
  mutate(day = day(date)) %>%
  mutate(wkofmonth = factor(as.numeric(date-floor_date(date, unit = "months")) %/% 7,levels = wk_levels)) %>%
  group_by(date,wkday,month,wkofmonth,day,educationLevel,agegroup)%>%
  summarise(Avgexpense = mean(-amount))

```

```{r}
D = as.Date("2022-03-03")
#as.numeric(D - floor_date(D, unit = "week")) %/% 7
floor_date(D, unit = "week")
```


```{r fig.width=10, fig.height=8}
dataset_4%>%
    group_by(date,wkday,month,wkofmonth,day)%>%
  summarise(Avgexpense = mean(Avgexpense)) %>%
  ggplot(aes(wkday,wkofmonth,fill=Avgexpense))+
  geom_tile(color = "white", size = 0.1)+
  geom_text(aes(label = day), color = "white") +
  facet_wrap(~month,nrow = 3) +
  theme_tufte(base_family = "Helvetica")+
  coord_equal() +
  scale_fill_gradient(name = "Expense",
                    low = "sky blue", 
                    high = "dark blue",
                    labels = comma)+
  labs(x = NULL, 
     y = NULL, 
     title = "Average Daily Expense of Residents") +
  theme(axis.text = element_text(size = 9,margin = margin(r = -60)),
        axis.ticks= element_blank(),
        axis.text.y = element_blank(),
        legend.title = element_text(size =16),
        legend.text = element_text(size = 16))
```


```{r fig.width=16, fig.height=8}
wkday_levels <- c('Sun','Mon','Tue','Wed','Thu','Fri','Sat')
wk_levels <- c(6,5,4,3,2,1)

dataset_4 <- dataset_1 %>%
  filter(!category %in% c("Shelter","Education")) %>%
  filter(amount<0) %>%
  mutate(date = as.Date(timestamp,"%m/%d/%Y")) %>%
    filter(date <'2023-03-01')%>%
  mutate(wkday = factor(weekdays(date,abbreviate = TRUE),levels = wkday_levels)) %>%
  mutate(month = month(date,label = TRUE)) %>%
  mutate(day = day(date)) %>%
  mutate(year = year(date))%>%
  mutate(wk = format(date, '%W')) %>%
  group_by(date,year,month,wk,wkday,day)%>%
  summarise(Avgexpense = mean(-amount))

```


```{r fig.width=10, fig.height=8}
dataset_4%>%
  ggplot(aes(wkday,wk,fill=Avgexpense))+
  geom_tile(color = "white") +
  facet_wrap(~month)
```


+
  geom_text(aes(label = day), color = "white") +
  facet_wrap(~month,nrow = 3, as.table = TRUE) +
  theme_tufte(base_family = "Helvetica")+
  coord_equal() +
  scale_fill_gradient(name = "Expense",
                    low = "sky blue", 
                    high = "dark blue",
                    labels = comma)+
  labs(x = NULL, 
     y = NULL, 
     title = "Average Daily Expense of Residents") +
  theme(axis.text = element_text(size = 9,margin = margin(r = -60)),
        axis.ticks= element_blank(),
        axis.text.y = element_blank(),
        legend.title = element_text(size =16),
        legend.text = element_text(size = 16))
```


```{r}

expense_month_data <- financial_data %>%
  mutate(date = as.Date(timestamp,"%m/%d/%Y")) %>%
  mutate(expense = round(abs(ifelse(amount<=0,amount,0)))) %>%
  filter(expense>0) %>%
  group_by(date)%>%
  summarise(AvgExpense = mean(expense))%>%
  mutate(month = factor(as.yearmon(date))) %>%
  mutate(day = day(date))

expense_month_data%>%
  ggplot(aes(day,month,fill=AvgExpense))+
  geom_tile(color = "white", size = 0.1)+
  theme_tufte(base_family = "Helvetica")+
  coord_equal() +
  scale_fill_gradient(name = "Expense",
                    low = "sky blue", 
                    high = "dark blue",
                    labels = comma)+
  labs(x = "Days of the Month", 
     y = NULL, 
     title = "Average Daily Expense of Residents") +
  theme(axis.text = element_text(size = 9,margin = margin(r = -60)),
        axis.ticks.y= element_blank(),
        legend.title = element_text(size =16),
        legend.text = element_text(size = 16))
```
```{r}

expense_part_month_data <- financial_data %>%
  mutate(date = as.Date(timestamp,"%m/%d/%Y")) %>%
  mutate(expense = round(abs(ifelse(amount<=0,amount,0)))) %>%
  filter(expense>0) %>%
  group_by(date)%>%
  summarise(AvgExpense = mean(expense))%>%
  mutate(month = factor(as.yearmon(date))) %>%
  mutate(day = day(date))%>%
  filter(day > 1)

expense_part_month_data$tooltip <- weekdays(expense_part_month_data$date)

p3 <- expense_part_month_data%>%
  ggplot(aes(day,month,fill=AvgExpense))+
  geom_tile_interactive(aes(tooltip = tooltip),color = "white", size = 0.1)+
  theme_tufte(base_family = "Helvetica")+
  coord_equal() +
  scale_fill_gradient(name = "Expense",
                    low = "sky blue", 
                    high = "dark blue",
                    labels = comma)+
  labs(x = "Day of the month", 
     y = NULL, 
     title = "Average Daily Expense of Residents") +
  theme(axis.text = element_text(size = 12,margin = margin(r = -60)),
        axis.ticks.y= element_blank(),
        legend.title = element_text(size =16),
        legend.text = element_text(size = 16),
        plot.title = element_text(size =18),
        axis.title.x = element_text(size = 14))

girafe(
  ggobj = p3,
  width_svg = 12,
  height_svg = 12*0.618
)

```


## Income distribution by educationLevel grouped by different periods
```{r}


Fin_data_for_plot%>%
  filter(educationLevel== "Graduate") %>%
  ggplot(aes(x=week_day, y = income))+
  geom_violin()+
   scale_y_continuous(breaks = seq(0, 10,1), limits = c(0,15))
```